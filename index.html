<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Algebra Past Papers</title>
    <link rel="icon" type="x-icon" href="fakeformative.png">
    <!-- Load external CSS styles -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Loading animation styles */
        @keyframes jump {
            0%, 20%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        .loading-dots {
            display: none;
        }
        .loading-dots.show {
            display: block;
            text-align: center;
        }
        .loading-dot {
            display: inline-block;
            margin: 0 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #000;
            animation: jump 1s infinite ease-in-out;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.1s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(4) {
            animation-delay: 0.3s;
        }
    </style>
</head>
<body>
    <center> <img src="favicon.png" width="200" height="200"> </center>
    <h3>-~- Maths, Science, History, English, Geography, French, Latin, Spanish and more!-~-</h3>

    <!-- Authentication form -->
    <div id="auth-form">
        <input type="text" id="key-input" placeholder="Enter key">
        <button onclick="authenticate()">Submit</button>
    </div>

    <!-- Loading animation -->
    <div class="loading-dots" id="loading-dots">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
    </div>

    <p id="error-msg" style="color: red; display: none;"></p>

    <script>
        // Function to authenticate using key
        async function authenticate() {
            // Show loading animation
            document.getElementById("auth-form").style.display = "none";
            document.getElementById("loading-dots").classList.add("show");

            const enteredKey = document.getElementById("key-input").value.trim();

            try {
                // Fetch keys.json from GitHub
                const response = await fetch('https://api.github.com/repos/schoolworkhelper/schoolworkhelper.github.io/contents/keys.json');
                const keysData = await response.json();

                // Parse keys.json content
                const keysContent = atob(keysData.content);
                const keysJson = JSON.parse(keysContent);

                // Check if entered key is valid
                const keyInfo = keysJson.keys.find(key => key.key === enteredKey);

                if (keyInfo) {
                    if (keyInfo.user_agent === "") {
                        // Allow entry and update user agent
                        keyInfo.user_agent = navigator.userAgent;
                        await updateKeysFile(keysJson);
                        redirectUser();
                    } else if (keyInfo.user_agent === navigator.userAgent) {
                        // Allow entry if user agent matches
                        redirectUser();
                    } else {
                        // Log failed attempt and refuse entry
                        logAttempt(enteredKey);
                        displayErrorMessage("This key has already been used with a different device.");
                    }
                } else {
                    // Key is invalid
                    displayErrorMessage("Invalid key. Please try again.");
                }
            } catch (error) {
                console.error('Error fetching or parsing keys.json:', error);
                displayErrorMessage("Error fetching keys. Please try again later.");
            } finally {
                // Hide loading animation
                document.getElementById("auth-form").style.display = "block";
                document.getElementById("loading-dots").classList.remove("show");
            }
        }

        // Function to update keys.json file on GitHub
        async function updateKeysFile(updatedKeysData) {
            try {
                // Personal access token for authentication
                const accessToken = '{{ secrets.GH_TOKEN }}'; // Reference GitHub secret

                // Headers for API requests
                const headers = {
                    'Authorization': `token ${accessToken}`,
                    'Content-Type': 'application/json'
                };

                // Update keys.json content
                const updatedContent = btoa(JSON.stringify(updatedKeysData));
                const requestBody = {
                    message: 'Update keys.json',
                    content: updatedContent,
                    sha: updatedKeysData.sha // SHA hash of the current file content
                };

                // Commit the changes to keys.json
                await fetch('https://api.github.com/repos/schoolworkhelper/schoolworkhelper.github.io/contents/keys.json', {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
            } catch (error) {
                console.error('Error updating keys.json:', error);
                // Handle error
            }
        }

        function redirectUser() {
            window.location.href = "games.html?redirected=true";
        }

        function logAttempt(enteredKey) {
            // Log failed attempt
            const logs = JSON.parse(localStorage.getItem('login_attempts')) || [];
            logs.push({ key: enteredKey, user_agent: navigator.userAgent, status: "failed" });
            localStorage.setItem('login_attempts', JSON.stringify(logs));

            // Log info to logs.txt
            const logText = `Key '${enteredKey}' has been attempted on a different device with user agent: ${navigator.userAgent}\n`;
            fetch('logs.txt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: logText
            });
        }

        function displayErrorMessage(message) {
            document.getElementById("error-msg").innerText = message;
            document.getElementById("error-msg").style.display = "block";
        }
    </script>
</body>
</html>
