<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Algebra Past Papers</title>
    <link rel="icon" type="x-icon" href="fakeformative.png">
    <!-- Load external CSS styles -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Loading animation styles */
        @keyframes jump {
            0%, 20%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        .loading-dots {
            display: none;
        }
        .loading-dots.show {
            display: block;
            text-align: center;
        }
        .loading-dot {
            display: inline-block;
            margin: 0 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #000;
            animation: jump 1s infinite ease-in-out;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.1s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(4) {
            animation-delay: 0.3s;
        }
    </style>
</head>
<body>
    <center> <img src="favicon.png" width="200" height="200"> </center>
    <h3>-~- Maths, Science, History, English, Geography, French, Latin, Spanish and more!-~-</h3>

    <!-- Authentication form -->
    <div id="auth-form">
        <input type="text" id="key-input" placeholder="Enter key">
        <button onclick="authenticate()">Submit</button>
    </div>

    <!-- Loading animation -->
    <div class="loading-dots" id="loading-dots">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
    </div>

    <p id="error-msg" style="color: red; display: none;"></p>

    <script>
        // Function to fetch valid keys from keys.json
        async function fetchValidKeys() {
            try {
                const response = await fetch('keys.json');
                const keysData = await response.json();
                return keysData.keys;
            } catch (error) {
                console.error('Error fetching valid keys:', error);
                return [];
            }
        }

        // Function to authenticate using key
        async function authenticate() {
            // Show loading animation
            document.getElementById("auth-form").style.display = "none";
            document.getElementById("loading-dots").classList.add("show");

            // Simulate loading for 4 seconds
            setTimeout(async () => {
                const enteredKey = document.getElementById("key-input").value.trim();
                const validKeys = await fetchValidKeys();

                // Check if the entered key is valid
                const keyInfo = validKeys.find(key => key.key === enteredKey);
                if (keyInfo) {
                    // Check if the key has been used before and user agent matches
                    const keyStatus = localStorage.getItem(enteredKey);
                    if (keyStatus === null || keyInfo.user_agent === "" || keyInfo.user_agent === navigator.userAgent) {
                        // Mark the key as used and update user agent
                        localStorage.setItem(enteredKey, "used");
                        keyInfo.user_agent = navigator.userAgent; // Update user agent

                        // Find the keyInfo object in the validKeys array
                        const keyToUpdate = validKeys.find(key => key.key === enteredKey);
                        if (keyToUpdate) {
                            // Update the user_agent property
                            keyToUpdate.user_agent = navigator.userAgent;

                            // Write the updated validKeys array back to the keys.json file
                            const updatedKeysData = { keys: validKeys };
                            fetch('keys.json', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(updatedKeysData)
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to update keys.json');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('keys.json updated successfully');
                                // Redirect the user
                                window.location.href = "games.html?redirected=true";
                            })
                            .catch(error => {
                                console.error('Error updating keys.json:', error);
                                // Handle error
                            });
                        } else {
                            console.error('Key not found in keys.json');
                            // Handle error
                        }
                    } else {
                        // Log failed attempt
                        const logs = JSON.parse(localStorage.getItem('login_attempts')) || [];
                        logs.push({ key: enteredKey, user_agent: navigator.userAgent, status: "failed" });
                        localStorage.setItem('login_attempts', JSON.stringify(logs));
                        // Log info to logs.txt
                        const logText = `Key '${enteredKey}' has been attempted on a different device with user agent: ${navigator.userAgent}\n`;
                        fetch('logs.txt', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain'
                            },
                            body: logText
                        });
                        // Key has already been used with a different user agent
                        document.getElementById("error-msg").innerText = "This key has already been used with a different device.";
                        document.getElementById("error-msg").style.display = "block";
                        // Hide loading animation
                        document.getElementById("auth-form").style.display = "block";
                        document.getElementById("loading-dots").classList.remove("show");
                    }
                } else {
                    // Key is invalid
                    document.getElementById("error-msg").innerText = "Invalid key. Please try again.";
                    document.getElementById("error-msg").style.display = "block";
                    // Hide loading animation
                    document.getElementById("auth-form").style.display = "block";
                    document.getElementById("loading-dots").classList.remove("show");
                }
            }, 4000); // 4 seconds
        }
    </script>
</body>
</html>
